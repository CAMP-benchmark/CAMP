#include <stdio.h>
#include <getopt.h>
#include <string.h>

#include "util.h"
#include "driver.h"

void welcome();
void usage();

#define MAXNAMELEN 20
#define MAXTAGLEN 30

int main(int argc, char *argv[]) {
    welcome();

    int c;

    char namebuf[MAXNAMELEN];
    char tag[MAXTAGLEN];
    Sequence *s_threads   = seq_alloc(), 
             *s_intensity = seq_alloc(),
             *s_hierarchy = seq_alloc(),
             *s_cpus      = seq_alloc();

    /* default parameters */
    strcpy(namebuf, "contig");
    gettimetag(tag, MAXTAGLEN-sizeof(".csv"));
    strcat(tag, ".csv");
    parse_seq(s_threads, "1, 2, +4:128:8");
    parse_seq(s_intensity, "+0:1:0.1, +2:10:1");
    parse_seq(s_hierarchy, "128, 64, 16, 8, 4");

    Parameter param = {
        .kernel = namebuf,
        .filename = tag,
        .threads = s_threads,
        .intensity = s_intensity,
        .size = 16000000,
        .distribution = cyclic,
        .cpus = s_cpus,
        .hierarchy = s_hierarchy,
        .scale = strong,
        .repeat = 3
    };
    
    struct option option_list[] = {
        {"kernel", required_argument, NULL, 'k'},
        {"filename", required_argument, NULL, 'f'},
        {"threads", required_argument, NULL, 't'},
        {"intensity", required_argument, NULL, 'i'},
        {"size", required_argument, NULL, 's'},
        {"repeat", required_argument, NULL, 'r'},
        {"help", no_argument, NULL, 'h'},
        {"distribution", required_argument, NULL, 'd'},
        {"strong", no_argument, &param.scale, strong},
        {"weak", no_argument, &param.scale, weak},
        {"cpus", required_argument, NULL, 'c'},
        {"hierarchy", required_argument, NULL, 'l'},
        {"quiet", no_argument, &quiet, 1},
        {0, 0, 0, 0}
    };

    while((c = getopt_long(argc, argv, "k:f:t:i:s:r:d:l:hc:q", option_list, NULL)) != -1){
        switch(c) {
        case 'k':
            strcpy(param.kernel, optarg);
            break;
        case 'f':
            strcpy(param.filename, optarg);
            break;
        case 't':
            parse_seq(param.threads, optarg);
            break;
        case 'i':
            parse_seq(param.intensity, optarg);
            break;
        case 's':
            param.size = atol(optarg);
            break;
        case 'r':
            param.repeat = atoi(optarg);
            break;
        case 'l':
            parse_seq(param.hierarchy, optarg);
            break;
        case 'd':
            parse_distribution(&param.distribution, optarg);
            break;
        case 'c':
            parse_seq(param.cpus, optarg);
            break;
        case 'h':
            usage();
            return 0;
        case 0:  /* fall through */
        case 'q':
            break;
        default:
            printf("Undefined.\n");
            return 0;
        }
    }
    report(argv[0], &param);
    
    write_init(param.filename);
    /* main function */
    loop(&param);
    write_final();

    seq_free(param.threads);
    seq_free(param.intensity);
    seq_free(param.hierarchy);
    seq_free(param.cpus);
    verbose("%sFinished\n",LINE);
    return 0;
}

void usage(){
    printf("Usage:\n");
    printf("\t -k, --kernel NAME \t\t name of the kernel - "
        "options are \"contig\", \"stride<size>\", \"random\", \"stencil<size>\", unless you implement your own kernel\n");
    printf("\t -f, --filename FILE \t\t file name to store result. Overwrite if exists, otherwise create new one\n");
    printf("\t -t, --threads LIST \t\t list of threads composed of number and sequence, sequence <op:begin:end:increasd> "
        "eg, \"1,2,+4:16:4\" => [1,2,4,8,12,16] \n");
    printf("\t -i, --intensity LIST \t\t list of opertional intensity composed of number and sequence\n");
    printf("\t -s, --size N \t\t\t size(numer of doubles) of each array allocated on each thread(core), "
        "N should be 4 times larger than the size of L3 cache\n");
    printf("\t -r, --repeat TIMES \t\t repeat.\n");
    printf("\t -h, --help \t\t\t Displays this help.\n");
    printf("\t -q, --quiet \t\t\t Silent mode, no output to STDOUT, history.txt.\n");
    printf("\t -l, --hierarchy LIST \t\t Hierary of the machine, number of cores from high to low "
        "eg, \"128,64,16,8,4\" => [<c/machine>,<c/socket>,<c/NUMA>,<c/CCD>,<c/CCX>]\n");
    printf("\t --cyclic, --stride, --block \t Automatic thread pinning, incompatible with explicit pinning.\n");
    printf("\t -c --cpu-bind LIST \t\t Explicit thread pinning. "
        "max(threads) must < len(LIST), incompatible with automatic pinning.\n");
    printf("\n\n");
}

void welcome() {
    /* ASCII art generated by http://patorjk.com/software/taag/ */
    printf(
        "\n====== CAMP (Configurable App for Memory Probe) ======\n"
        "                 ________   __  ______                 \n"
        "                / ___/ _ | /  |/  / _ \\                \n"
        "               / /__/ __ |/ /|_/ / ___/                \n"
        "               \\___/_/ |_/_/  /_/_/                    \n"
        LINE
    );
}